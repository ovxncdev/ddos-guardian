# DDoS Guardian - Docker Compose
# 
# Usage:
#   docker-compose up -d
#   docker-compose logs -f guardian
#   docker-compose down

version: '3.8'

services:
  # ===================
  # DDoS Guardian
  # ===================
  guardian:
    build: .
    container_name: ddos-guardian
    restart: unless-stopped
    ports:
      - "80:3000"      # Public HTTP
      # - "443:3000"   # Uncomment for HTTPS (with reverse proxy)
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOST=0.0.0.0
      
      # Upstream services (your Nginx)
      - UPSTREAM_HOSTS=http://nginx:80
      
      # Rate limiting
      - RATE_LIMIT_WINDOW_MS=60000
      - RATE_LIMIT_MAX_REQUESTS=100
      - RATE_LIMIT_BLOCK_DURATION_MS=300000
      
      # Bot detection
      - BOT_DETECTION_ENABLED=true
      - BOT_SCORE_THRESHOLD=70
      
      # Logging
      - LOG_LEVEL=info
      - LOG_FORMAT=json
      
      # Security
      - TRUST_PROXY=true
      - STEALTH_MODE=true
    
    volumes:
      - guardian-logs:/var/log/ddos-guardian
      - guardian-data:/var/lib/ddos-guardian
    
    networks:
      - guardian-network
    
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    
    depends_on:
      - nginx

  # ===================
  # Your Nginx (example)
  # ===================
  nginx:
    image: nginx:alpine
    container_name: nginx
    restart: unless-stopped
    # No public ports - only accessible through guardian
    expose:
      - "80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      # Add your app configs here
    networks:
      - guardian-network
    
    # Uncomment to connect to your app services
    # depends_on:
    #   - service-a
    #   - service-b

  # ===================
  # Your Services (examples)
  # ===================
  # service-a:
  #   image: your-js-service:latest
  #   expose:
  #     - "3000"
  #   networks:
  #     - guardian-network
  
  # service-b:
  #   image: your-go-service:latest
  #   expose:
  #     - "8080"
  #   networks:
  #     - guardian-network

# ===================
# Networks
# ===================
networks:
  guardian-network:
    driver: bridge

# ===================
# Volumes
# ===================
volumes:
  guardian-logs:
  guardian-data:
